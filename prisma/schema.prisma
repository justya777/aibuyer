generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum TenantMemberRole {
  ADMIN
  MEMBER
}

enum AuditResult {
  SUCCESS
  ERROR
  BLOCKED
}

enum DsaSource {
  MANUAL
  RECOMMENDATION
}

enum TenantPageSource {
  BUSINESS_OWNED
  FALLBACK_UNVERIFIED
  FALLBACK_CONFIRMED
}

enum AiRunStatus {
  PENDING
  RUNNING
  SUCCESS
  PARTIAL
  ERROR
}

model User {
  id                     String         @id @default(cuid())
  email                  String         @unique
  passwordHash           String?
  oauthProvider          String?
  oauthProviderAccountId String?
  role                   UserRole       @default(USER)
  activeTenantId         String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  activeTenant           Tenant?        @relation("ActiveTenant", fields: [activeTenantId], references: [id], onDelete: SetNull)
  tenantMemberships      TenantMember[]
  auditLogs              AuditLog[]

  @@unique([oauthProvider, oauthProviderAccountId])
  @@index([activeTenantId])
}

model Tenant {
  id                 String              @id @default(cuid())
  name               String
  businessId         String?             @unique
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  members            TenantMember[]
  businesses         BusinessPortfolio[]
  assets             TenantAsset[]
  adAccounts         TenantAdAccount[]
  pages              TenantPage[]
  pixels             TenantPixel[]
  adAccountSettings  AdAccountSettings[]
  auditLogs          AuditLog[]
  activeUsers        User[]              @relation("ActiveTenant")
}

model BusinessPortfolio {
  id         String    @id @default(cuid())
  tenantId   String
  businessId String
  label      String?
  lastSyncAt DateTime?
  deletedAt  DateTime?
  deletedBy  String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, businessId])
  @@index([tenantId, createdAt])
  @@index([tenantId, deletedAt])
}

model TenantMember {
  id        String           @id @default(cuid())
  userId    String
  tenantId  String
  role      TenantMemberRole @default(MEMBER)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model TenantAsset {
  id          String   @id @default(cuid())
  tenantId    String
  adAccountId String
  createdAt   DateTime @default(now())
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, adAccountId])
  @@index([adAccountId])
}

model AuditLog {
  id        String      @id @default(cuid())
  tenantId  String
  userId    String?
  action    String
  assetId   String?
  summary   String
  result    AuditResult
  timestamp DateTime    @default(now())
  metadata  Json?
  tenant    Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, timestamp])
  @@index([userId, timestamp])
  @@index([action, timestamp])
}

model TenantAdAccount {
  id           String   @id @default(cuid())
  tenantId     String
  businessId   String?
  adAccountId  String
  name         String?
  status       String?
  currency     String?
  timezoneName String?
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, adAccountId])
  @@index([tenantId, businessId])
  @@index([adAccountId])
  @@index([tenantId, lastSyncedAt])
}

model TenantPage {
  id         String           @id @default(cuid())
  tenantId   String
  businessId String?
  pageId     String
  name       String?
  tasksJson  Json?
  source     TenantPageSource @default(BUSINESS_OWNED)
  lastSeenAt DateTime         @default(now())
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  tenant     Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pageId])
  @@index([tenantId, businessId])
  @@index([pageId])
  @@index([tenantId, lastSeenAt])
  @@index([tenantId, source])
}

model TenantPixel {
  id           String   @id @default(cuid())
  tenantId     String
  businessId   String?
  adAccountId  String?
  pixelId      String
  name         String?
  ownerBmId    String?
  verified     Boolean  @default(false)
  permissionOk Boolean  @default(true)
  lastSeenAt   DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pixelId])
  @@index([tenantId, adAccountId])
  @@index([pixelId])
}

model AdAccountSettings {
  id              String    @id @default(cuid())
  tenantId        String
  businessId      String?
  adAccountId     String
  defaultPageId   String?
  defaultPixelId  String?
  dsaBeneficiary  String?
  dsaPayor        String?
  dsaSource       DsaSource @default(MANUAL)
  dsaUpdatedAt    DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, adAccountId])
  @@index([tenantId, businessId])
  @@index([adAccountId])
  @@index([tenantId, defaultPageId])
}

model AiRun {
  id             String      @id @default(cuid())
  userId         String
  tenantId       String
  businessId     String?
  adAccountId    String
  commandText    String
  status         AiRunStatus @default(PENDING)
  startedAt      DateTime    @default(now())
  finishedAt     DateTime?
  createdIdsJson Json?
  summaryJson    Json?
  snapshotJson   Json?
  retries        Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  events         AiRunEvent[]
  snapshots      AiRunSnapshot[]

  @@index([tenantId, adAccountId, startedAt])
  @@index([tenantId, businessId, startedAt])
  @@index([userId, startedAt])
}

model AiRunSnapshot {
  id               String   @id @default(cuid())
  runId            String
  entityType       String
  entityId         String
  sanitizedPayload Json
  createdAt        DateTime @default(now())
  run              AiRun    @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@unique([runId, entityType, entityId])
  @@index([runId])
  @@index([entityType, entityId])
}

model AiRunEvent {
  id               String   @id @default(cuid())
  runId            String
  type             String
  stepId           String?
  label            String?
  summary          String?
  status           String?
  userTitle        String?
  userMessage      String?
  rationale        String?
  debugJson        Json?
  createdIdsJson   Json?
  requestPayload   Json?
  sanitizedPayload Json?
  attempt          Int?
  durationMs       Int?
  errorCode        String?
  errorSubcode     String?
  fbtraceId        String?
  ts               DateTime @default(now())
  run              AiRun    @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, ts])
  @@index([type, ts])
}
